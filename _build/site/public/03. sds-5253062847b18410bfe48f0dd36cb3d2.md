---
title: Key Transfer System
subtitle: Software Design Specification
subject: DataMax Project
short_title: Software Design Specification
date: 2023-03-24
authors:
  - name: Tsvetelina Georgieva
    roles:
      - writing
      - review
      - visualisation
    email: cgeorgieva@datamax.bg
license: Apache-2.0
github: https://github.com/flower4e/key-transfer-myst.git
keywords: 3DS, security, acquiring
exports:
  - format: pdf
    template: plain_latex
    article_type: Report
---


## Използвани термини

| Термин                        | Описание                                                     |
| ----------------------------- | ------------------------------------------------------------ |
| **Криптографскa смарт картa** | Специализиран криптографски хардуер, който позволява да се използват  алгоритми като RSA и DSA; позволява да се генерира двойка секретни ключове на самата карта. |
| **Key Transfer Utility**      | Мобилно приложение, което има роля на криптографскa смарт картa. Разработено е с цел пренос на данни на криптографски ключове. |
| **Картов четец**              | Устройство, което предава данни на криптографскa смарт карта чрез безконтактна технология |
| **APDU**                      | Application Protocol Data Units - Команди, които четецът изпраща на смарт картата и съответно чете отговорите от нея |
| **BDK**                       | Base Derivation Key - Основен ключ за извличане. BDK случайно генериран и с негова помощ се  извеждат всички ключове на терминали |
| **HSM**                       | Hardware Security Module - Модул за хардуерна сигурност – физическо изчислително устройство, което защитава и управлява цифрови ключове, изпълнява функции за криптиране и декриптиране за цифрови  подписи, силно удостоверяване и други криптографски функции |

## Въведение

Този документ съдържа подробно описание на софтуерната архитектура и дизайн на Система за пренос на криптографски данни, чрез която се осъществява пренос на криптографски ключове и техните данни между отделни устройства и карти. Документът има за цел да улови и предаде значимите архитектурни и дизайнерски решения и да покаже как дизайнът ще изпълни функционалните и нефункционалните изисквания, описани в документ System Requirements Specification.  

## Система за пренос на криптографски данни

В Система за пренос на криптографски данни се осъществява пренос данни на криптографски ключове. Обменът се извършва между картов четец - криптографска смарт карта - терминал, в съответствие PCI Security Standard, както и с останалите международно приети норми, разпоредби и стандарти за сигурност.

## Участници

Участниците и компонентите в процеса на пренос на данни на криптографски ключове са следните:

- Hardware
  - Terminal Key Distribution Station
  - HSM
  - Картов четец 
  - Терминал
  - Мобилно устройство_1
  - Мобилно устройство_2
  
- Software
  - Linux
  - Android OS
  - Key Transfer Utility
  - Terminal-kdc 
  - BDK
  - APDU

### Terminal Key Distribution Station

Terminal Key Distribution Station e станция, работеща с OS Linux, на която е инсталиран софтуер terminal-kdc и с която е свързан картов четец. 

### HSM

HSM е свързан с Terminal Key Distribution Station. Terminal-kdc ползва BDK от HSM.

### Картов четец

Четецът е свързан с Terminal Key Distribution Station и предава данните от terminal-kdc на криптографска смарт карта чрез APDU. 

### Терминал

На терминал се зареждат ключовете, които са предварително предназначени конкретно за него. Ключове, които не съдържат данни на съответен терминал, не могат да бъдат заредени. 

Трансферът се извършва чрез мобилно приложение Key Transfer Utility, което има роля на крипто смарт карта.

### Мобилно устройство

С цел на осигуряване сигурността на криптографските ключове, в процеса на експорт на TMK и PPK се ползват 2бр. мобилни устройства, на които се качват отделните компоненти на криптографски ключ. 

Мобилните устройства оперират с OS Android. 

На мобилните устройства е инсталирано приложение Key Transfer Utility.

### Key Transfer Utility

Key Transfer Utility е мобилно приложение, което има роля на криптографскa смарт картa. С негова помощ се осъществява трансфер на криптографски ключове.

### Linux

Terminal Key Distribution Station работи с OS Linux.

OS Linux изисква удостоверяване на потребителя чрез потребителско име и парола.

След осъществяване на вход, системата извежда директно интерфейса на terminal-kdc, където следва да се въведат данни на ключ за трансфер.

### Terminal-kdc

Terminal-kdc е софтуер, инсталиран на Terminal Key Distribution Station.

Чрез terminal-kdc се осъществява зареждане на криптографски ключове, които предстои да бъдат трансферирани на смарт карта. 

Качване на BDK на Key Distribution Station:

- Администратор въвежда ръчно на terminal-kdc етикет на ключ и компоненет 1 и 2 на ключа
- изпраща ги на Key Distribution Station 
- Key Distribution Station ги изпраща на HSM заедно с importSecretKey
- HSM изпраща BDK на key-distribution-station

Трансфер на ключ:

Чрез terminal-kdc се въвежда:

- тип на ключа (TMK, PPK, etc.) 
- идентификационен номер на терминал, за който е предназначен трансфера
- начин на трансфер
  - TMK: export
  - PPK: export / wrap. 

Процедура export разделя ключа на два компонента, които се трансферират на две различни мобилни устройства с инсталирано приложение Key Transfer Utility. 

### BDK

BDK са генерирани на случаен принцип от HSM. Чрез BDK се извеждат всички ключове на терминали.

### APDU Протокол

Application Protocol Data Units (APDU) са команди, които четецът изпраща на смарт картата и съответно чете отговорите от нея. 

APDU се изпраща от четеца към картата, като съдържа задължителен 4-byte header (CLA, INS, P1, P2) и от 0 до 65 535 байта данни. В случаите, когато данните са повече от 256 байта, се прилага допълнително разделяне на фрагменти.

#### FCI structure, BER encoded

| 6F NN             |                                                              |
| ----------------- | ------------------------------------------------------------ |
| NN                | LC (Length of Content)<br />дължината на цялата следваща част: |
| 80 02 VV VV       | version                                                      |
| 81 04 BB BB BB BB | feature and protocol bits                                    |

Example:

```
  0  10: [APPLICATION 15] {
  2   2:   [0] 12 34
  6   4:   [1] FF FF 00 00
       :   }
```

#### PUT DATA Plain Block, BER encoded

| 6F NN                                                 |                                                              |
| ----------------------------------------------------- | ------------------------------------------------------------ |
| NN                                                    | LC (Length of Content)<br />дължината на цялата следваща част: |
| 80 02 XX YY                                           | 02 - размерът на данните от тази част<br />XX - block type indicator<br />YY - control information<br />първо 00 за ТМК, <br />0F за PPK, <br />второ 00 за wrap <br />0x02 за експорт на два компонента, първи компонент, <br />0x12 за втори компонент |
| 81 LL AA BB CC ...                                    | target terminal ID                                           |
| 81 N1 XX XX XX                                        | N1 - размер на ID на терминала                               |
| 82 N2 XX XX XX                                        | N2 - размерът на ключа за пренос<br />Кoгато се извършва експорт на компонент-1 и компонент-2, се слага само една част. Ако са два компонента, те се експортират в две отделни сесии, а обект 80 казва коя част се експортира |
| 82 10 KK KK KK KK KK KK KK KK KK KK KK KK KK KK KK KK | key value / component                                        |
| 83 03 XX XX XX                                        | 03 - размер на KCV И KCV = XX XX XX                          |
| 84 VV VV VV                                           | key check value                                              |

Example:

```
  0  34: [APPLICATION 10] {
  2   2:   [0] 00 00
  6   5:   [1] 12 44 56 78 99
 13  16:   [2] 44 AB 06 F8 25 5E E6 AC D4 27 04 FD B4 AE A4 08
 31   3:   [4] AA BB CC
       :   }
```

## Роли

Роли, права и отговорности по работа със системата са подробно описани в документ [System Requirements Specification](#srs).

## История на промените

| Версия | Дата       | Описание                                                     | Извършил промяната |
| ------ | ---------- | ------------------------------------------------------------ | ------------------ |
| 1.0    | 13.01.2023 | Начална версия                                               | Ц. Георгиева       |
| 1.1    | 24.03.2023 | Добавено второ мобилно устройство за разделяне двата компонента на крипт. ключ при трансфер | Ц. Георгиева       |
